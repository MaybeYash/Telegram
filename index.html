<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1f1c2c, #928dab);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ffffff;
            flex-direction: column;
        }

        .container {
            text-align: center;
            max-width: 500px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.2);
            background: rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        h1, h3 {
            font-weight: 600;
        }

        .message {
            font-size: 1.3em;
            margin-top: 20px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: auto;
        }

        .close-button {
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            color: #ffffff;
            background: #3498db;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);
            transition: background 0.3s;
        }

        .close-button:hover {
            background: #2978b5;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <h1>Welcome To "Flow : Beyond"</h1>
        <h3 id="loading">Fetching your join date...</h3>
        <div id="loader" class="loader"></div>
        <p id="message" class="message"></p>
    </div>

    <!-- Close button below the container -->
    <button class="close-button" onclick="closeWebApp()">Close</button>

    <script>
        window.onload = async function () {
            const tg = window.Telegram.WebApp;
            if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                document.getElementById('loading').textContent = "Please open this app inside Telegram.";
                return;
            }

            const userId = tg.initDataUnsafe.user.id;

            // Correct API call and data handling in JavaScript
            async function getCreationDate(id) {
                const url = "https://restore-access.indream.app/regdate";
                const headers = {
                    "accept": "*/*",
                    "content-type": "application/x-www-form-urlencoded",
                    "user-agent": "Nicegram/92 CFNetwork/1390 Darwin/22.0.0",
                    "x-api-key": "e758fb28-79be-4d1c-af6b-066633ded128",
                    "accept-language": "en-US,en;q=0.9"
                };
                const data = { "telegramId": id };

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify(data),
                    });

                    const result = await response.json();
                    if (result && result.data && result.data.date) {
                        return result.data.date;
                    } else {
                        throw new Error("Failed to retrieve date");
                    }
                } catch (error) {
                    return "N/A";
                }
            }

            // Calculate and format join date in JavaScript
            try {
                const joinDate = await getCreationDate(userId);

                if (joinDate !== "N/A") {
                    const [joinYear, joinMonth] = joinDate.split('-').map(Number);
                    const joinDateObject = new Date(joinYear, joinMonth - 1, 1);
                    const now = new Date();

                    // Calculate the difference in years and months
                    let diffYears = now.getFullYear() - joinDateObject.getFullYear();
                    let diffMonths = now.getMonth() - joinDateObject.getMonth();

                    if (diffMonths < 0) {
                        diffYears -= 1;
                        diffMonths += 12;
                    }

                    let message = "";

                    if (diffYears > 0) {
                        message = `You Joined Telegram Approximately ${diffYears} year${diffYears > 1 ? "s" : ""} and ${diffMonths} month${diffMonths > 1 ? "s" : ""} ago!`;
                    } else {
                        message = `You Joined Telegram Approximately ${diffMonths} month${diffMonths > 1 ? "s" : ""} ago!`;
                    }

                    document.getElementById('message').textContent = message;
                } else {
                    document.getElementById('message').textContent = "Could not retrieve your join date.";
                }

                document.getElementById('loading').textContent = "";
                document.getElementById('loader').style.display = "none";
                tg.expand();

            } catch (error) {
                document.getElementById('loading').textContent = "Error fetching join date!";
                document.getElementById('loader').style.display = "none";
            }
        };

        // Function to close the Telegram web app
        function closeWebApp() {
            const tg = window.Telegram.WebApp;
            tg.close(); // Close the web app
        }
    </script>
</body>
</html>
